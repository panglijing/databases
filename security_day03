+++++++++++++监控与安全_day03_学习任务
	一、Linux基本防护

[root@localhost ~]# useradd  bob
]# echo "123456" |# echo  "123456" | passwd --stdin bob
[root@localhost ~]# chage -d 0 bob
[root@localhost ~]# chage -E 2020/12/31 bob
[root@localhost ~]# chage -l bob
最近一次密码修改时间					：密码必须更改
密码过期时间					：密码必须更改
密码失效时间					：密码必须更改
帐户过期时间						：12月 31, 2020
两次改变密码之间相距的最小天数		：0
两次改变密码之间相距的最大天数		：99999
在密码过期之前警告的天数	：7
[root@localhost ~]# 

root@localhost ~]# useradd bob2
[root@localhost ~]# echo "123456" | passwd --stdin bob2
更改用户 bob2 的密码 。
passwd：所有的身份验证令牌已经成功更新。
[root@localhost ~]# 
[root@localhost ~]# passwd  -S bob2
bob2 PS 2020-04-07 0 99999 7 -1 (密码已设置，使用 SHA512 算法。)
[root@localhost ~]# 
[root@localhost ~]# passwd  -l bob2
锁定用户 bob2 的密码 。
passwd: 操作成功
[root@localhost ~]# passwd  -S bob2
bob2 LK 2020-04-07 0 99999 7 -1 (密码已被锁定。)
[root@localhost ~]# passwd  -u bob2
解锁用户 bob2 的密码。
passwd: 操作成功
[root@localhost ~]# passwd  -S bob2
bob2 PS 2020-04-07 0 99999 7 -1 (密码已设置，使用 SHA512 算法。)
[root@localhost ~]# 			

[root@localhost ~]# passwd -l bob2
锁定用户 bob2 的密码 。
passwd: 操作成功
[root@localhost ~]# grep bob2 /etc/shadow
bob2:!!$6$18zJ7QKh$QlWchH8ZN0KGgbML.fgm9MEndg5weesnnMIMFeEck89eRXR/NQdh2zMg/yy6FmvG7.pWN5xS6LPgBLd0.IHF4/:18359:0:99999:7:::
[root@localhost ~]# 
[root@localhost ~]# passwd  -S bob2
bob2 LK 2020-04-07 0 99999 7 -1 (密码已被锁定。)
[root@localhost ~]# 

]# grep -v "#" /etc/login.defs  


[root@localhost ~]# vim /etc/issue
[root@localhost ~]# cat /etc/issue.net 
\S
Kernel \r on an \m
[root@localhost ~]# vim /etc/issue.net 
[root@localhost ~]# 
[root@localhost ~]# cat /etc/issue
window  server 2000
[root@localhost ~]#


RHEL7 systemctl  start|stop|restart httpd
RHEL6 service   httpd  start|stop|restart

RHEL7  systemctl enable|disable httpd
RHEL6  chkconfig httpd on|off


[root@localhost ~]# lsattr  /etc/hosts
---------------- /etc/hosts
[root@localhost ~]# chattr  +i /etc/hosts
[root@localhost ~]# lsattr  /etc/hosts
----i----------- /etc/hosts
[root@localhost ~]# 

[root@localhost ~]# rm -rf /etc/hosts
rm: 无法删除"/etc/hosts": 不允许的操作
[root@localhost ~]# 
[root@localhost ~]# mv /etc/hosts /tmp/
mv: 无法将"/etc/hosts" 移动至"/tmp/hosts": 不允许的操作
[root@localhost ~]# 

[root@localhost ~]# lsattr  /etc/passwd
---------------- /etc/passwd
[root@localhost ~]# useradd bob6
[root@localhost ~]# grep bob6 /etc/passwd
bob6:x:1003:1003::/home/bob6:/bin/bash
[root@localhost ~]# 
[root@localhost ~]# chattr +a /etc/passwd
[root@localhost ~]# grep bob7 /etc/passwd
[root@localhost ~]# useradd bob7
useradd：无法打开 /etc/passwd
[root@localhost ~]# echo  "xxxx" >> /etc/passwd
[root@localhost ~]# tail -1 /etc/passwd
xxxx
[root@localhost ~]# chattr -a /etc/passwd
[root@localhost ~]# useradd bob7
[root@localhost ~]# sed -i '/^xxx/d' /etc/passwd
[root@localhost ~]#

			二、用户切换与提权   
		2.1 用户切换 su 
		    命令格式：
			
[john@localhost ~]$ su - root -c 'netstat  -utnlp  | grep zabbix_agentd'
密码：
tcp        0      0 0.0.0.0:10050           0.0.0.0:*               LISTEN      3539/zabbix_agentd  
[john@localhost ~]$ 

]# cat /var/log/secure 记录su 切换信息

		2.2 用户提权 sudo（重点）
			定义：系统的管理员root用户，给系统的普通用户，配置可以使用root用户命令的权限。
			主配置文件  /etc/sudoers
			打开文件的方式： visudo  或 vim  /etc/sudoers

			提权格式：
			普通用户名	服务器主机名列表=提权命令列表 （命令要写绝对路径）
			%用户组名	服务器主机名列表=提权命令列表

			普通用户查看可用执行的提权命令 sudo  -l  (首次查看需要输入自己登陆系统的密码)
			普通用户执行提权命令 sudo 提权命令

			例子： 给系统普通用户john ，使其可以管理mairadb数据库服务器
			useradd john
			echo 123456  | passwd --stdin  john

[root@localhost ~]# which  rpm
/usr/bin/rpm
[root@localhost ~]# which  yum
/usr/bin/yum
[root@localhost ~]# which  systemctl
/usr/bin/systemctl
[root@localhost ~]# 
[root@localhost ~]# which  vim
/usr/bin/vim
[root@localhost ~]#

			]# vim +92 /etc/sudoers
                        john	localhost,web200=/usr/bin/rpm , /usr/bin/yum , /usr/bin/systemctl  *  mariadb , /usr/bin/vim /etc/my.cnf

:wq

john@web200 ~]$ sudo -l
[sudo] john 的密码：
匹配 %2$s 上 %1$s 的默认条目：
    !visiblepw, always_set_home, match_group_by_gid, env_reset, env_keep="COLORS DISPLAY
    HOSTNAME HISTSIZE KDEDIR LS_COLORS", env_keep+="MAIL PS1 PS2 QTDIR USERNAME LANG
    LC_ADDRESS LC_CTYPE", env_keep+="LC_COLLATE LC_IDENTIFICATION LC_MEASUREMENT LC_MESSAGES",
    env_keep+="LC_MONETARY LC_NAME LC_NUMERIC LC_PAPER LC_TELEPHONE", env_keep+="LC_TIME
    LC_ALL LANGUAGE LINGUAS _XKB_CHARSET XAUTHORITY",
    secure_path=/sbin\:/bin\:/usr/sbin\:/usr/bin

用户 john 可以在 web200 上运行以下命令：
    (root) /usr/bin/rpm, /usr/bin/yum, /usr/bin/systemctl * mariadb, /usr/bin/vim /etc/my.cnf
[john@web200 ~]$ 
[john@web200 ~]$ sudo rpm -q mariadb-server
未安装软件包 mariadb-server 
[john@web200 ~]$ sudo rpm -q mariadb
未安装软件包 mariadb 
[john@web200 ~]$ 
[john@web200 ~]$ sudo yum -y install mariadb-server mariadb

[john@web200 ~]$ sudo systemctl  start mariadb
[john@web200 ~]$ ls /var/lib/mysql/
aria_log.00000001  ibdata1      ib_logfile1  mysql.sock          test
aria_log_control   ib_logfile0  mysql        performance_schema
[john@web200 ~]$ 
[john@web200 ~]$ sudo vim /etc/my.cnf
[mysqld]
log_bin
server_id=1
:wq
[john@web200 ~]$ sudo systemctl  restart mariadb
[john@web200 ~]$ 
[john@web200 ~]$ ls /var/lib/mysql/
aria_log.00000001  ib_logfile0         mariadb-bin.index  performance_schema
aria_log_control   ib_logfile1         mysql              test
ibdata1            mariadb-bin.000001  mysql.sock
[john@web200 ~]$

		启用日志 记录普通用户执行的提权命令

]# vim /etc/sudoers  (写在文件的末尾)
Defaults  logfile="/var/log/sudo"
:wq


[root@web200 ~]# vim /var/log/sudo.log   （执行过提权命令会自动创建文件并记录执行的命令）


sudo别名设置：（别名名称必须用大写字母）
	定义用户别名 User_Alias  别名名称=用户列表
	定义主机别名 Host_Alias  别名名称=主机名列表
	定义命令别名 Cmnd_Alias  别名名称=命令列表
[root@web200 ~]# vim /etc/sudoers

Cmnd_Alias SHARECMD=/usr/bin/rpm , /usr/bin/yum

Cmnd_Alias DBACMD=/usr/bin/systemctl  *  mariadb , /usr/bin/vim /etc/my.cnf

Cmnd_Alias WEBCMD=/usr/bin/systemctl  *  httpd , /usr/bin/vim /etc/httpd/conf/httpd.conf

Cmnd_Alias STORAGE = /sbin/fdisk, /sbin/sfdisk, /sbin/parted, /sbin/partprobe, /bi    n/mount, /bin/umount

User_Alias MYUSER= zhangsan ,lisi

Host_Alias MYSER=localhost,web200

MYUSER MYSER=SHARECMD , STORAGE , DBACMD
john MYSER=WEBCMD , SHARECMD

:wq! 

